-- ============================================================
-- ğŸ‘¥ ì „ì²´ ìœ ì € ëª©ë¡ ì¡°íšŒ ê¸°ëŠ¥ ì¶”ê°€ (auth.users ì—°ë™)
-- ê¸°ë³¸ì ìœ¼ë¡œ í”„ë¡ íŠ¸ì—”ë“œì—ì„œëŠ” auth.users í…Œì´ë¸”ì„ ì§ì ‘ ì¡°íšŒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
-- ë³´ì•ˆ ë·°(View)ë¥¼ ìƒì„±í•˜ì—¬ ê´€ë¦¬ìë§Œ ì „ì²´ ìœ ì € ëª©ë¡ì„ ë³¼ ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.
-- ============================================================

-- 1. ê¸°ì¡´ ë·°ê°€ ìˆë‹¤ë©´ ì‚­ì œ
DROP VIEW IF EXISTS public.users_view;

-- 2. ê´€ë¦¬ìë§Œ ë³¼ ìˆ˜ ìˆëŠ” Secure View ìƒì„±
-- auth.users í…Œì´ë¸”ì—ì„œ í•„ìš”í•œ ì •ë³´ë§Œ ê°€ì ¸ì˜¤ê³ , ê´€ë¦¬ì ì´ë©”ì¼ì¸ì§€ ì²´í¬í•©ë‹ˆë‹¤.
CREATE OR REPLACE VIEW public.users_view AS
SELECT 
    id, 
    email, 
    created_at, 
    last_sign_in_at
FROM auth.users
WHERE (
    -- ğŸ” ë³´ì•ˆ ì²´í¬: ìš”ì²­ìì˜ ì´ë©”ì¼ì´ ê´€ë¦¬ìì¼ ë•Œë§Œ ê²°ê³¼ ë°˜í™˜
    auth.jwt() ->> 'email' IN ('petblo12@gmail.com', 'admin@minsim.com')
);

-- 3. ê¶Œí•œ ë¶€ì—¬ (Authenticated ìœ ì €ì—ê²Œ ì¡°íšŒ ê¶Œí•œì„ ì£¼ì§€ë§Œ, ìœ„ ì¡°ê±´ ë•Œë¬¸ì— ê´€ë¦¬ìë§Œ ë°ì´í„°ê°€ ë³´ì„)
GRANT SELECT ON public.users_view TO authenticated;

-- 4. í™•ì¸
SELECT * FROM public.users_view;
